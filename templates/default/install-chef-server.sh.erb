#!/bin/bash

chef-server-ctl reconfigure

<% if node['chef-server']['create-user'] -%>
echo
echo --------------------------------------
echo Create User
echo --------------------------------------
echo

# Let it start after server reconfigure
sleep 5

chef-server-ctl user-create <%= node['chef-server']['username'] %> \
 "<%= node['chef-server']['user_first_name'] %>" \
 "<%= node['chef-server']['user_last_name'] %>" \
 "<%= node['chef-server']['user_email'] %>" \
 "<%= node['chef-server']['password'] %>" \
 --filename <%= node['chef-server']['pem-dir']%>/<%= node['chef-server']['username'] %>.pem

chef-server-ctl org-create <%= node['chef-server']['org_short_name'] %> \
 "<%= node['chef-server']['org_long_name'] %>" \
 --association_user <%= node['chef-server']['username'] %> \
 --filename <%= node['chef-server']['pem-dir']%>/<%= node['chef-server']['org_short_name'] %>-validator.pem

<% end -%>

<% if node['chef-server']['install-web-ui'] -%>
echo
echo --------------------------------------
echo Install Web UI
echo --------------------------------------
echo

chef-server-ctl install opscode-manage
opscode-manage-ctl reconfigure
chef-server-ctl reconfigure
<% end -%>

<% if node['chef-server']['install-push-jobs-server'] -%>
echo
echo --------------------------------------
echo Install Push Jobs Server
echo --------------------------------------
echo

chef-server-ctl install opscode-push-jobs-server
opscode-push-jobs-server-ctl reconfigure
chef-server-ctl reconfigure
<% end -%>

<% if node['chef-server']['install-reporting'] -%>
echo
echo --------------------------------------
echo Install Reporting
echo --------------------------------------
echo

chef-server-ctl install opscode-reporting
opscode-reporting-ctl reconfigure
chef-server-ctl reconfigure
<% end -%>